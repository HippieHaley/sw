generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  username      String    @unique
  passwordHash  String
  createdAt     DateTime  @default(now())
  lastLogin     DateTime?
  
  // Encrypted profile data
  encryptedData String?   // Stores any optional profile info encrypted
  
  posts         Post[]
  platforms     Platform[]
  
  @@map("users")
}

model Post {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Encrypted content
  encryptedTitle       String
  encryptedDescription String?
  encryptedFilePath    String?  // Path to scrubbed media file
  
  // Scheduling
  scheduledFor    DateTime?
  publishedAt     DateTime?
  status          String    @default("draft") // draft, scheduled, published, failed
  
  // Platform-specific data
  platformPosts   PlatformPost[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("posts")
  @@index([userId, scheduledFor])
}

model Platform {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  userId              String    @db.ObjectId
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  platformName        String    // twitter, instagram, reddit, etc.
  
  // OAuth tokens (encrypted)
  encryptedAccessToken  String?
  encryptedRefreshToken String?
  tokenExpiresAt        DateTime?
  
  // Legacy API key support (encrypted) - for platforms without OAuth
  encryptedConfig     String?
  
  // Platform-specific data
  externalUserId      String?   // User ID from the external platform
  externalUsername    String?   // Username on the external platform
  
  customHashtags      String?   // Comma-separated hashtags for this platform
  isActive            Boolean   @default(true)
  
  platformPosts       PlatformPost[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([userId, platformName])
  @@map("platforms")
}

model PlatformPost {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  postId          String    @db.ObjectId
  post            Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  platformId      String    @db.ObjectId
  platform        Platform  @relation(fields: [platformId], references: [id], onDelete: Cascade)
  
  externalId      String?   // ID from external platform
  status          String    @default("pending") // pending, posted, failed
  errorMessage    String?
  
  postedAt        DateTime?
  
  @@map("platform_posts")
  @@index([postId])
}
